# TODO: refactor once graphql supports `extend`
# https://github.com/graphql/graphql-js/issues/922\
#scalar Upload

directive @subscriptionsTriggered(
  signatures: [String!]!
) on FIELD_DEFINITION

enum RwRoomMessageContentType {
  TEXT
  CONFIG
}

type Query {
  _empty: String
  # RwUser
  rwUser(id: ID!): RwUser
  rwUsers: [RwUser!]
  # RwDeck
  rwDeck(id: ID!): RwDeck
  rwOwnDecks: [RwDeck!]
  # RwCard
  rwCard(id: ID!): RwCard
  rwCardsOfDeck(deckId: ID!): [RwCard!]
  # RwRoom
  rwRoom(id: ID!): RwRoom
  rwInRooms: [RwRoom!]
  # RwRoomMessage
  rwRoomMessage(id: ID!): RwRoomMessage
  rwRoomMessagesOfRoom(roomId: ID!): [RwRoomMessage!]
}

type Mutation {
  _empty: String
  # Authorization
  signin(
    email: String!
    name: String
    token: String!
    authorizer: String!
    identifier: String!
    persist: Boolean
  ): RwAuthResponse
  # Deck
  rwDeckCreate(
    name: String
    description: String
    nameLang: String
    promptLang: String
    answerLang: String
  ): RwDeck @subscriptionsTriggered(
    signatures: ["rwOwnDecksUpdates<deck's owner>", "rwDeckTopic(<deck's id>)"]
  )
  rwDeckCreateFromRows(
    name: String
    description: String
    nameLang: String
    promptLang: String
    answerLang: String
    rows: [[String!]!]!
  ): RwDeck @subscriptionsTriggered(
    signatures: ["rwOwnDecksUpdates<deck's owner's id>", "rwDeckTopic(<deck's id>)"]
  )
  rwDeckEdit(
    id: ID!
    name: String
    description: String
    nameLang: String
    promptLang: String
    answerLang: String
  ): RwDeck @subscriptionsTriggered(
    signatures: ["rwOwnDecksUpdates<deck's owner's id>", "rwDeckTopic(<deck's id>)"]
  )
  rwDeckAddSubdeck(id: ID!, subdeckId: ID!): RwDeck @subscriptionsTriggered(
    signatures: ["rwOwnDecksUpdates<parent deck's owner>", "rwDeckTopic(<parent deck's id>)"]
  )
  rwDeckDelete(id: ID!): ID @subscriptionsTriggered(
    signatures: ["rwOwnDecksUpdates<deck's owner>", "rwDeckTopic(<deck's id>)"]
  )
  # Card
  rwCardCreate(
    deckId: ID!
    prompt: String!
    fullAnswer: String!
    answers: [String!]
    sortKey: String
    template: Boolean
  ): RwCard @subscriptionsTriggered(
    signatures: ["rwCardsUpdatesOfDeck(<card's deck's id>)"]
  )
  rwCardsCreate(
    deckId: ID!
    multiplicity: Int!
    prompt: String!
    fullAnswer: String!
    answers: [String!]
    sortKey: String
    template: Boolean
  ): [RwCard!] @subscriptionsTriggered(
    signatures: ["rwCardsUpdatesOfDeck(<cards' deck's id>)"]
  )
  rwCardEdit(
    id: ID!
    prompt: String
    fullAnswer: String
    answers: [String!]
    sortKey: String
    template: Boolean
  ): RwCard @subscriptionsTriggered(
    signatures: ["rwCardsUpdatesOfDeck(<card's deck's id>)"]
  )
  rwCardDelete(id: ID!): ID @subscriptionsTriggered(
    signatures: ["rwCardsUpdatesOfDeck(<card's deck's id>)"]
  )
  # Room
  rwRoomCreate(config: IRoomConfigInput!): RwRoom @subscriptionsTriggered(
    signatures: ["rwRoomUpdates(<room's id>)"]
  )
  rwRoomUpdateConfig(id: ID! config: IRoomConfigInput!): RwRoom @subscriptionsTriggered(
    signatures: ["rwRoomUpdates(<room's id>)"]
  )
  rwRoomAddOccupant(id: ID! occupantId: ID!): RwRoom @subscriptionsTriggered(
    signatures: ["rwRoomUpdates(<room's id>)"]
  )
  rwRoomDeactivate(id: ID!): RwRoom @subscriptionsTriggered(
    signatures: ["rwRoomUpdates(<room's id>)"]
  )

  # RoomMessage
  rwRoomMessageCreate(
    roomId: ID!
    content: String!
    contentType: RwRoomMessageContentType!
  ): RwRoomMessage @subscriptionsTriggered(
    signatures: ["rwRoomMessagesUpdatesOfRoom(<room's id>)"]
  )
}

type Subscription {
  _empty: String
  # Deck
  rwOwnDecksUpdates: RwDeckUpdate!
  rwDeckUpdates(id: ID!): RwDeckUpdate!
  # Card
  rwCardsUpdatesOfDeck(deckId: ID!): RwCardUpdate!
  # Room
  rwRoomUpdates(id: ID!): RwRoomUpdate!
  # RoomMessage
  rwRoomMessagesUpdatesOfRoom(roomId: ID!): RwRoomMessageUpdate!
}

type RwDeckCreated { created: RwDeck }
type RwDeckUpdated { updated: RwDeck }
type RwDeckDeleted { deletedId: ID }
union RwDeckUpdate = RwDeckCreated | RwDeckUpdated | RwDeckDeleted

type RwCardCreated { created: RwCard }
type RwCardUpdated { updated: RwCard }
type RwCardDeleted { deletedId: ID }
union RwCardUpdate = RwCardCreated | RwCardUpdated | RwCardDeleted

type RwRoomMessageCreated { created: RwRoomMessage }
type RwRoomMessageUpdated { updated: RwRoomMessage }
type RwRoomMessageDeleted { deletedId: ID }
union RwRoomMessageUpdate = RwRoomMessageCreated | RwRoomMessageUpdated | RwRoomMessageDeleted

type RwRoomCreated { created: RwRoom }
type RwRoomUpdated { updated: RwRoom }
type RwRoomDeleted { deletedId: ID }
union RwRoomUpdate = RwRoomCreated | RwRoomUpdated | RwRoomDeleted

# RwDeck

type RwDeck {
  id: ID!
  name: String!
  description: String!
  nameLang: String!
  promptLang: String!
  answerLang: String!
  owner: RwUser!
  subdecks: [RwDeck!]!
  cards: [RwCard!]!
}

# RwCard

type RwCard {
  id: ID!
  prompt: String!
  fullAnswer: String!
  answers: [String!]!
  sortKey: String!
  deck: RwDeck!
  editedAt: String!
  template: Boolean!
}

# RwRoom

type RwRoom {
  id: ID!
  inactive: Boolean!
  config: IRoomConfig!
  owner: RwUser!
  occupants: [RwUser!]!
  messages: [RwRoomMessage!]!
}

# RwRoomMessage

type RwRoomMessage {
  id: ID!
  content: String!
  contentType: RwRoomMessageContentType!
  sender: RwUser
  room: RwRoom
}

# RwAuthorization

type RwAuthResponse {
  user: RwUser!
  token: String!
}

# RwUser

type RwUser {
  id: ID!
  email: String!
  name: String
  roles: [String!]!
  decks: [RwDeck!]!
}

# IRoomConfig
input IRoomConfigInput {
  deckId: ID
  deckName: String
  deckNameLang: String
  roundLength: Int
  clientDone: Boolean
}

type IRoomConfig {
  deckId: ID
  deckName: String
  deckNameLang: String
  roundLength: Int
  clientDone: Boolean
}
